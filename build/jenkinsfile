pipeline {
  agent {
    label 'agent1'
   }
  parameters {
        string(name: 'ImageTag', defaultValue: 'springapp-rc-1.0', description: 'ImageTag') 
  }
  tools {
    maven 'maven'
    git 'git'
  }

  environment {
    SCANNER_HOME = tool 'sonar-scanner'
    NEXUSURL_HOST = "52.66.146.193:8081"
    }

  stages{
        stage("Clean Workspace") { 
            steps {
                cleanWs()
            }
        }

        stage("App Codeckeckout"){
            steps {
                git branch: "javaapp", url:"https://github.com/prateekkumawat/jenkins-11-project-ci.git"
            }  
        }
        
        stage ("Sonar Analysis"){
            steps{
                dir('springapp/'){
                    withSonarQubeEnv('sonar-server') {
                       sh ''' 
                         mvn clean verify sonar:sonar  \
                        -Dsonar.projectKey=java-build-app \
                        -Dsonar.projectName=java-build-app  '''
                    }
                }             
            }
        }

        stage("Sonar QualityGate"){
            steps{
                script {
                  waitForQualityGate abortPipeline: false, credentialsId: 'sonar-token' 
                }
            }
        }

        stage("Artifacts Upload"){
            steps{
                dir('springapp/'){
                    sh  'mvn clean install package'
                    nexusArtifactUploader(
                    nexusVersion: 'nexus3',
                    protocol: 'http',
                    nexusUrl: "${env.NEXUSURL_HOST}",
                    groupId: 'com.example',
                    version: "1.0.0-SNAPSHOT",
                    repository: 'maven-snapshot',  // use a PyPI-like repo in Nexus
                    credentialsId: 'nexus-creds',
                    artifacts: [
                        [artifactId: "demo" ,
                        classifier: '',
                        file: "target/demo-1.0.0-SNAPSHOT.jar",
                        type: 'jar']
                    ]
                   )
                }        
            }
        }

        stage("build Image"){
            steps{
                sh "docker build -t prateekkumawat/jenkinsimage:${params.ImageTag} ."
            }
        }

        stage("Trivy ImageScan"){
            steps{
                sh "trivy image prateekkumawat/jenkinsimage:${params.ImageTag} >> /home/ubuntu/scanner_report/${params.ImageTag}_report.txt"
            }
        }


        stage("Image push"){
            environment {
                DOCKER_CREDS = credentials('docker-creds')
            }
            steps{
                sh "docker login -u $DOCKER_CREDS_USR -p $DOCKER_CREDS_PSW "
                sh "docker push prateekkumawat/jenkinsimage:${params.ImageTag}" 
            }
        }

        stage("Container Build"){
            environment {
                DOCKER_CREDS = credentials('docker-creds')
            }
            steps{
                sh '''
                   echo " build compose"
                ''' 
            }
        }

        stage("Teams Notify") {
            steps {
                script {
                    withCredentials([string(credentialsId: 'teams-notify', variable: 'WEBHOOK_URL')]) {
                        sh """
                        curl -H 'Content-Type: application/json' \
                        -d '{
                        "@type": "MessageCard",
                        "@context": "http://schema.org/extensions",
                        "summary": "Jenkins job Build",
                        "themeColor": "00FF00",
                        "title": "Jenkins Job: ${env.JOB_NAME}",
                        "sections": [{
                            "facts": [
                                { "name": "ðŸŸ¢ **Status**", "value": "**SUCCESS âœ…**" },
                                { "name": "ðŸ”¢ **Build**", "value": "**#${env.BUILD_NUMBER}**" },
                                { "name": "ðŸŒ¿ **Branch / Tag**", "value": "**${env.GIT_BRANCH ?: params.GIT_REF}**" },
                                { "name": "ðŸ”¢ **ImageName**", "value": "**prateekkumawat/jenkinsimage:${params.ImageTag}**" },
                                { "name": "ðŸ”— **Build URL**", "value": "[**Open Build**](${env.BUILD_URL})" }
                            ],
                            "text": "ðŸš€ **Build completed successfully!**"
                        }]
                        }' \
                        \$WEBHOOK_URL
                        """
                    }
                }
            }
        }
    }
}