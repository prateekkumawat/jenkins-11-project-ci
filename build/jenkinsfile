pipeline {
  agent {
    label 'agent1'
   }
  parameters {
        string(name: 'ImageTag', defaultValue: 'pythonapp-rc-1.0', description: 'ImageTag') 
  }
  environment {
    SCANNER_HOME = tool 'sonar-scanner'
    NEXUSURL_HOST = "13.232.47.45:8081"
    }

  stages{
        stage("Clean Workspace") { 
            steps {
                cleanWs()
            }
        }

        stage("App Codeckeckout"){
            steps {
                git branch: "pyhtonbuild", url:"https://github.com/prateekkumawat/jenkins-11-project-ci.git"
            }  
        }
        
        stage ("Sonar Analysis"){
            steps{
                dir('app/'){
                    withSonarQubeEnv('sonar-server') {
                       sh ''' 
                        $SCANNER_HOME/bin/sonar-scanner \
                        -Dsonar.projectKey=python-build-app \
                        -Dsonar.projectName=python-build-app  '''
                    }
                }             
            }
        }

        stage("Sonar QualityGate"){
            steps{
                script {
                  waitForQualityGate abortPipeline: false, credentialsId: 'sonar-token' 
                }
            }
        }

        stage("TrivyFS Scan"){
          steps{
            sh ' trivy fs app >> /home/ubuntu/scanner_report/fs_${params.ImageTag}_report.txt'   
          }
        }
        
        stage("Artifacts Upload"){
            steps{
                dir('app/'){
                    nexusArtifactUploader(
                    nexusVersion: 'nexus3',
                    protocol: 'http',
                    nexusUrl: "${env.NEXUSURL_HOST}",
                    groupId: 'demoapp',
                    version: "${env.PACKAGE_VERSION}",
                    repository: 'pythonbuild',  // use a PyPI-like repo in Nexus
                    credentialsId: 'nexus-creds',
                    artifacts: [
                        [
                            artifactId: "",
                            classifier: '',
                            file: "dist/${env.WHL_FILE}",
                            type: 'whl'
                        ],
                        [
                            artifactId: "",
                            classifier: '',
                            file: "dist/${env.TAR_FILE}",
                            type: 'tar.gz'
                        ]
                    ]
                   )
                }        
            }
        }

        stage("build Image"){
            steps{
                sh "docker build -t prateekkumawat/jenkinsimage:${params.ImageTag} ."
            }
        }

        stage("Trivy ImageScan"){
            steps{
                sh "trivy image prateekkumawat/jenkinsimage:${params.ImageTag} >> /home/ubuntu/scanner_report/${params.ImageTag}_report.txt"
            }
        }


        stage("Image push"){
            environment {
                DOCKER_CREDS = credentials('docker-creds')
            }
            steps{
                sh "docker login -u $DOCKER_CREDS_USR -p $DOCKER_CREDS_PSW "
                sh "docker push prateekkumawat/jenkinsimage:${params.ImageTag}" 
            }
        }

        stage("Container Build"){
            environment {
                DOCKER_CREDS = credentials('docker-creds')
            }
            steps{
                sh '''
                   echo " build compose"
                ''' 
            }
        }
    }
}