pipeline {
  agent {
    label 'agent1'
   }

   environment {
        // Path to the kubeconfig file
        KUBECONFIG = "${WORKSPACE}/kubeconfig"
   }

    stages{
        stage("Clean Workspace") { 
            steps {
                cleanWs()
            }
        }

        stage("App Codeckeckout"){
            steps {
                git branch: "pythonbuild", url:"https://github.com/prateekkumawat/jenkins-11-project-ci.git"
            }  
        }
        
        stage("kubernetes-deployment"){
            steps{
                withCredentials([file(credentialsId: 'kube-config', variable: 'KUBECONFIG_FILE')]) {
                sh """
                    cp $KUBECONFIG_FILE $KUBECONFIG
                    chmod 600 $KUBECONFIG
                    kubectl apply -f deployment/mysql/namespace.yaml --validate=false
                    kubectl apply -f deployment/mysql/deployment.yaml --validate=false
                    kubectl apply -f deployment/mysql/service.yaml --validate=false
                    kubectl apply -f deploymen/pythonapp/namespace.yaml --validate=false
                    kubectl apply -f deploymen/pythonapp/deployment.yaml --validate=false
                    kubectl apply -f deploymen/pythonapp/service.yaml --validate=false
                 """ 
                }   
            }
        }

        stage("Teams Notify") {
            steps {
                script {
                    withCredentials([string(credentialsId: 'teams-notify', variable: 'WEBHOOK_URL')]) {
                        sh """
                        curl -H 'Content-Type: application/json' \
                        -d '{
                        "@type": "MessageCard",
                        "@context": "http://schema.org/extensions",
                        "summary": "Jenkins job Build",
                        "themeColor": "00FF00",
                        "title": "Jenkins Job: ${env.JOB_NAME}",
                        "sections": [{
                            "facts": [
                                { "name": "ðŸŸ¢ **Status**", "value": "**SUCCESS âœ…**" },
                                { "name": "ðŸ”¢ **Build**", "value": "**#${env.BUILD_NUMBER}**" },
                                { "name": "ðŸŒ¿ **Branch / Tag**", "value": "**${env.GIT_BRANCH ?: params.GIT_REF}**" },
                                { "name": "ðŸ”¢ **ImageName**", "value": "**prateekkumawat/jenkinsimage:${params.ImageTag}**" },
                                { "name": "ðŸ”— **Build URL**", "value": "[**Open Build**](${env.BUILD_URL})" }
                            ],
                            "text": "ðŸš€ **Build completed successfully!**"
                        }]
                        }' \
                        \$WEBHOOK_URL
                        """
                    }
                }
            }
        }
    }
}