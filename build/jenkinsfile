pipeline {
  agent {
    label 'agent1'
   }
  parameters {
        string(name: 'ImageTag', defaultValue: 'latest', description: 'ImageTag') 
  }
  stages{
        stage("Clean Workspace") { 
            steps {
                cleanWs()
            }
        }

        stage("App Codeckeckout"){
            steps {
                git branch: "main", url:"https://github.com/prateekkumawat/jenkins-11-project-ci.git"
            }  
        }

        stage("build Image"){
            steps{
                sh "docker build -t prateekkumawat/jenkinsimage:${params.ImageTag} ."
            }
        }

        stage("Image push"){
            environment {
                DOCKER_CREDS = credentials('docker-creds')
            }
            steps{
                sh "docker login -u $DOCKER_CREDS_USR -p $DOCKER_CREDS_PSW "
                sh "docker push prateekkumawat/jenkinsimage:${params.ImageTag}" 
            }
        }

        stage("container releaes"){
            environment {
                DOCKER_CREDS = credentials('docker-creds')
            }
            steps{
                sh '''
                  docker login -u $DOCKER_CREDS_USR -p $DOCKER_CREDS_PSW 
                  docker-compose pull 
                  docker-compose up -d 
                '''
            }


        }
    }
}