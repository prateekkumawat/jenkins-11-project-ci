pipeline {
  agent {
    label 'agent1'
   }
  parameters {
        string(name: 'ImageTag', defaultValue: 'phpapp-rc-1.0', description: 'ImageTag') 
  }
  environment {
    SCANNER_HOME = tool 'sonar-scanner'
    }

  stages{
        stage("Clean Workspace") { 
            steps {
                cleanWs()
            }
        }

        stage("App Codeckeckout"){
            steps {
                git branch: "phpapp", url:"https://github.com/prateekkumawat/jenkins-11-project-ci.git"
            }  
        }
        
        stage ("Sonar Analysis"){
            steps{
                dir('src/'){
                    withSonarQubeEnv('sonar-server') {
                       sh ''' 
                        $SCANNER_HOME/bin/sonar-scanner \
                        -Dsonar.projectKey=jenkins-php-test-project \
                        -Dsonar.projectName=jenkins-php-test-project  '''
                    }
                }             
            }
        }

        stage("Sonar QualityGate"){
            steps{
                script {
                  waitForQualityGate abortPipeline: false, credentialsId: 'sonar-token' 
                }
            }
        }

        stage("build Image"){
            steps{
                sh "docker build -t prateekkumawat/jenkinsimage:${params.ImageTag} ."
            }
        }

        stage("Trivy Scan"){
            steps{
                sh "trivy image prateekkumawat/jenkinsimage:${params.ImageTag} >> /home/ubuntu/scanner_report/${params.ImageTag}_report.txt"
            }
        }


        stage("Image push"){
            environment {
                DOCKER_CREDS = credentials('docker-creds')
            }
            steps{
                sh "docker login -u $DOCKER_CREDS_USR -p $DOCKER_CREDS_PSW "
                sh "docker push prateekkumawat/jenkinsimage:${params.ImageTag}" 
            }
        }

        stage("Container Build"){
            environment {
                DOCKER_CREDS = credentials('docker-creds')
            }
            steps{
                sh '''
                  docker login -u $DOCKER_CREDS_USR -p $DOCKER_CREDS_PSW
                  docker-compose pull 
                  docker-compose up -d 
                ''' 
            }
        }
    }
}